<!-- templates/applications/scanning.html -->
{% extends 'base.html' %}

{% block title %}Scanning Documents{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto bg-white p-10 rounded-lg shadow-md mt-10 text-center">

    <h2 class="text-2xl font-bold text-gray-800 mb-4">Scanning Your Documents</h2>
    <p id="scan-message" class="text-gray-600 mb-6">Initializing scan...</p>

    <!-- Progress Bar -->
    <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden shadow-inner">
        <div id="scan-progress-bar" 
             class="bg-blue-600 h-6 text-xs font-medium text-white text-center leading-none transition-all duration-500"
             style="width: 0%;">
        </div>
    </div>

    <p class="text-gray-500 mt-4 text-sm">Please wait while we analyze your documents.</p>
</div>

<script>
    const taskId = "{{ task_id }}";

    function checkProgress() {
        fetch(`/scan-progress/${taskId}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById("scan-message").innerText = data.message;
                document.getElementById("scan-progress-bar").style.width = data.progress + "%";

                if (data.progress < 100) {
                    setTimeout(checkProgress, 800);
                } else {
                    window.location.href = `/scan-result/${taskId}/`;
                }
            });
    }

    checkProgress();

   function checkProgress() {
  fetch(progressUrl, { credentials: "same-origin" })
    .then(r => {
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    })
    .then(data => {
      document.getElementById("scan-message").innerText = data.message || "Workingâ€¦";
      document.getElementById("scan-progress-bar").style.width = (data.progress || 0) + "%";

      if ((data.progress || 0) < 100) setTimeout(checkProgress, 800);
      else window.location.href = resultUrl;
    })
    .catch(err => {
      document.getElementById("scan-message").innerText =
        "Progress error: " + err.message + " (check server logs)";
      setTimeout(checkProgress, 1500);
    });
}

</script>
{% endblock %}
