{% extends 'base.html' %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'pdfjs/web/viewer.css' %}">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between mb-2">
  <h4>{{ gen.template.template_type }} for Payment {{ gen.payment.id }}</h4>
  <div>
    <a class="btn btn-outline-success" href="{% url 'finance:pdf_download' gen.id %}">Download</a>
    <button id="saveEdited" class="btn btn-primary">Save Edited</button>
  </div>
  <form action="{% url 'finance:upload_signed_pdf' gen.id %}" method="post" enctype="multipart/form-data">
  {% csrf_token %}
  <div class="mb-2">
    <label class="form-label">Upload signed/scanned PDF</label>
    <input type="file" name="signed_pdf" accept="application/pdf" class="form-control" required>
  </div>
  <div class="mb-2">
    <textarea name="notes" class="form-control" placeholder="Notes (optional)"></textarea>
  </div>
  <button class="btn btn-success">Upload Signed PDF</button>
</form>

</div>

<!-- PDF.js viewer iframe or container -->
<iframe id="pdfViewer" src="{% static 'pdfjs/web/viewer.html' %}?file={{ gen.file.url|urlencode }}" width="100%" height="80vh"></iframe>

<script>
  // Save edited PDF: PDF.js default viewer does not provide "save" by default.
  // This snippet assumes you have a custom build or plugin that exposes the edited PDF as a blob.
  // If using a custom viewer that exposes `window.getEditedPdfBlob()`, call it and POST to server.

  document.getElementById('saveEdited').addEventListener('click', async function() {
    // Example: ask the iframe for the edited PDF blob via postMessage
    const iframe = document.getElementById('pdfViewer');
    // send message to iframe to request edited PDF
    iframe.contentWindow.postMessage({ action: 'requestEditedPdf' }, '*');

    // Listen for response
    window.addEventListener('message', async function handler(event) {
      if (!event.data || event.data.action !== 'editedPdf') return;
      window.removeEventListener('message', handler);
      const base64 = event.data.base64; // base64 PDF string
      const blob = base64ToBlob(base64, 'application/pdf');
      const form = new FormData();
      form.append('edited_pdf', blob, 'edited.pdf');
      // CSRF token
      const csrftoken = getCookie('csrftoken');
      const resp = await fetch("{% url 'finance:save_edited_pdf' gen.id %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken },
        body: form
      });
      const data = await resp.json();
      if (data.status === 'ok') {
        alert('Edited PDF saved successfully.');
        location.reload();
      } else {
        alert('Save failed.');
      }
    });
  });

  function base64ToBlob(base64, type='application/pdf') {
    const binary = atob(base64);
    const len = binary.length;
    const buffer = new Uint8Array(len);
    for (let i=0;i<len;i++) buffer[i]=binary.charCodeAt(i);
    return new Blob([buffer], {type});
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
